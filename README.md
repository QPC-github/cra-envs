<p align="center">
    <img src="https://user-images.githubusercontent.com/6702424/147039599-3783531a-a23f-48eb-88c4-413790f4c0ec.png">  
</p>
<p align="center">
    <i>ðŸ›  Use environment variables in create-react-app projects ðŸ› </i>
    <br>
    <br>
    <a href="https://github.com/garronej/cra-envs/actions">
      <img src="https://github.com/garronej/cra-envs/workflows/ci/badge.svg?branch=main">
    </a>
    <a href="https://bundlephobia.com/package/cra-envs">
      <img src="https://img.shields.io/bundlephobia/minzip/cra-envs">
    </a>
    <a href="https://github.com/garronej/cra-envs/blob/main/LICENSE">
      <img src="https://img.shields.io/npm/l/cra-envs">
    </a>
</p>

Distribute customizable create-react-app!  

# Motivation

We want to be able to do `docker run --env FOO="xyz" my-org/my-create-react-app` 
then access `FOO` in the app like `process.env["FOO"]`.  

We want to be able to access our env in the `public/index.html` file: [example](https://github.com/garronej/cra-envs-demo-app/blob/e1aa8067b52a563bc5db18558e7ed7746a56c9c0/public/index.html#L129).  

> ðŸ’¡ `public/index.html` support EJS ([really](https://github.com/facebook/create-react-app/issues/3112#issuecomment-328829771))!  
> 
> This would enable us to conditionally [preload one font or another](https://github.com/garronej/cra-envs-demo-app/blob/e1aa8067b52a563bc5db18558e7ed7746a56c9c0/public/index.html#L6-L21).

Create react app provides no official way to inject environment variable from the server into the page.  
When you run `yarn build` create react app does bundle all the variables prefixed by `REACT_APP_`
and expose them under `process.env` ([see here](https://create-react-app.dev/docs/adding-custom-environment-variables/)).  
The problem, however, is that you likely don't want to build your app on the server.  
For this use case the CRA team suggests to [introduce placeholders](https://create-react-app.dev/docs/title-and-meta-tags/#injecting-data-from-the-server-into-the-page) in the `public/index.html` 
and do the substitution on the server before serving the app. This solution involves a lot of hard to maintain scripting.

This module abstract away the burden of managing environment variable injection as well as providing a type-safe way
to access them in your code.

# Setup example

Find ðŸ‘‰[**here**](https://github.com/garronej/cra-envs-demo-app)ðŸ‘ˆ a demo setup with a fresh create-react-app.

![image](https://user-images.githubusercontent.com/6702424/111223899-09e26d00-85de-11eb-84ea-566f9ed58eee.png)

![image](https://user-images.githubusercontent.com/6702424/111223405-685b1b80-85dd-11eb-977c-e8ea1eda1e29.png)

# More details on how it works

Start by installing the tool: 

```bash
yarn add cra-envs 
```

Then declare all the allowed environment variables into the `.env` file of your project

Example
```ini
REACT_APP_FOO="Default value of foo"
REACT_APP_BAR=
REACT_APP_BAZ=
REACT_APP_FIZZ=
```

Once it's done run the script `npx generate-env-getter` ( Use `npx generate-env-getter js` if you your project don't use TypeScript)

It will generate `src/env.ts` ( or `src/env.js`) looking like:
```typescript
/* 
* Automatically generated by cra-envs.
* If you wish to declare a new environment variable declare it in the .env file (prefixed by REACT_APP_)
* then run 'npx generate-env-getter' at the root of your project.
* This file will be updated.
*/
import { getEnvVarValue } from "cra-envs";

export const envNames = [
  "FOO",
  "BAR",
  "BAZ",
  "FIZZ"
] as const;

export type EnvNames = typeof envNames[number];

let env: Record<EnvNames, string> | undefined = undefined;

export function getEnv() {

    if (env === undefined) {
        env = {} as Record<EnvNames, string>;
        for (const envName of envNames) {
            env[envName] = getEnvVarValue(envName);
        }
    }

    return env;

}
```
(This file should be gitignored)  

Now let's test it by creating a `.env.local` file like:  
```ini
REACT_APP_BAR="Value of bar defined in .env.local"
```

And let's do this somewhere in our code: 

```typescript
import { getEnv } from "./env.ts"

console.log(getEnv());
```
Now if we run `REACT_APP_BAZ="Value of baz passed inline" yarn start` we get this
in the console: 

```json
{
    "FOO": "Default value of foo",
    "BAR": "Value of bar defined in .env.local",
    "BAZ": "Value of baz passed inline",
    "FIZZ": ""
}
```

Now if you run `yarn build` then `BAZ="Value of baz on the server" npx embed-environnement-variables`
the value of `BAZ` will be injected in `build/index.html` (or `html/index.html`) so that if you 
start statically serving
the `build/` dir, for example with `serve -s build` you will get this in the console:  

```json
{
    "FOO": "Default value of foo",
    "BAR": "Value of baz on the server",
    "BAZ": "",
    "FIZZ": ""
}
```

Note that on the server the environment variable names don't need to be prefixed with `REACT_APP_` (they can though).
Also note that the script runs very fast and thus represent virtually no overhead when starting your container.  
By default `embed-environnement-variables` does not embed variables defined in `.env.local`, if you want to include
them use: `--includes-.env.local` or `-i`.

The next step is to set up a clean Dockerfile where there is both node and Ngnix available.  
Node for being able to run `npx embed-environnement-variables` and Ngnix for serving the app.  
It is also important to make sure `cra-envs` is not bootstraped by `npx` in the entrypoint.
